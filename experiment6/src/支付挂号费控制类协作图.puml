@startuml
' 支付挂号费用例 - 纯控制类协作图
' 仅定义核心控制类对象
object "挂号费金额计算控制类" as P1
object "支付宝支付对接控制类" as P2
object "缴费状态同步控制类" as P3
object "退费处理控制类" as P4

skinparam default {
  FontName 微软雅黑
  FontSize 9
}

' 基础消息传递格式：对象1 -- 对象2 : 序号. 消息内容
' 核心交互流程
P1 -- P1 : 1. 查询患者年龄 + 基础挂号费标准
P1 -- P1 : 2. 判断是否≥60岁，计算应缴金额
' 免费流程（患者≥60岁）
P1 -- P3 : 3. 传递免费信息（患者ID+预约ID+金额0元），请求同步缴费状态
P3 -- P3 : 4. 创建0元支付记录 + 生成挂号单
P3 -- P3 : 5. 更新预约记录缴费状态（已缴费）
P3 -- P1 : 6. 返回免费缴费同步结果
' 支付宝缴费流程
P1 -- P2 : 7. 传递应缴金额 + 预约/患者信息，请求发起支付宝支付
P2 -- P2 : 8. 调用支付宝支付接口，传递支付参数
P2 -- P2 : 9. 接收支付宝支付回调结果（成功/失败）
' 支付成功则同步状态；支付失败则可选触发退费】
P2 -- P3 : 10. 支付成功，传递支付单号+金额，请求同步缴费状态
P3 -- P3 : 11. 创建支付宝支付记录
P3 -- P3 : 12. 更新预约缴费状态 + 生成挂号单
P3 -- P2 : 13. 返回缴费状态同步结果
P2 -- P1 : 14. 返回支付宝支付成功结果
' 支付失败流程
P2 -- P1 : 15. 支付失败，返回失败提示
P2 -- P4 : 16. 支付异常，请求退费处理
P4 -- P4 : 17. 执行退费逻辑，回滚支付状态
P4 -- P2 : 18. 返回退费处理结果
@enduml