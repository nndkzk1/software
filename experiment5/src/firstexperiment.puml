@startuml
' 支付模块活动图（含线上/现场/免费/退费场景）
start
:用户完成预约挂号，生成预约记录;
:系统校验患者年龄;
if (患者年龄≥60岁?) then (是)
  :系统标记"免缴费";
  if (线上操作?) then (是)
    :用户打印挂号单;
  else (否)
    :挂号处工作人员打印挂号单并盖章;
  endif
  :发送"免缴费"短信通知;
  :结束（可直接分诊）;
else (否)
  :用户选择支付方式;
  if (选择线上支付宝支付?) then (是)
    :系统展示待缴费金额;
    :调用支付宝支付接口;
    if (支付宝支付成功?) then (是)
      :系统生成缴费记录，标记"已缴费";
      :发送"缴费成功"短信;
      :用户打印挂号单;
      :结束（可分诊）;
    else (否)
      :提示"支付失败";
      :返回重新选择支付方式;
    endif
  else (选择现场支付)
    :用户持预约单到挂号处;
    :工作人员查询预约记录;
    if (预约记录有效?) then (是)
      :工作人员收取费用;
      :系统标记"已缴费"，生成缴费记录;
      :打印挂号单并盖章;
      :结束（可分诊）;
    else (否)
      :告知"预约记录无效";
      :流程终止;
    endif
  endif
endif

' 退费分支
fork
  :用户就诊前1天发起线上取消预约;
  :系统校验"已缴费"且未过时限;
  if (校验通过?) then (是)
    :调用支付宝退费接口（线上支付）/标记人工退费（现场）;
    if (退费成功?) then (是)
      :更新缴费记录为"已退费";
      :发送"退费成功"短信;
    else (否)
      :标记"退费中"，人工核查;
      :发送"退费处理中"短信;
    endif
  else (否)
    :提示"取消失败/不可退费";
  endif
fork again
  :用户违约（未取消未就诊）;
  :系统标记"已违约";
  :费用不予退回，信用等级-1;
  :发送"违约警告"短信;
end fork
stop
@enduml